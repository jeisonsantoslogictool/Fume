@page "/resetpassword"
@inject IRepository repository
@inject SweetAlertService sweetAlertService
@inject NavigationManager navigationManager

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-lg">
                <div class="card-header text-white text-center py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3 class="mb-0">
                        <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" />
                        <br />
                        Restablecer Contraseña
                    </h3>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted text-center mb-4">
                        Ingresa el código de recuperación y tu nueva contraseña.
                    </p>

                    <EditForm Model="model" OnValidSubmit="ResetPasswordAsync">
                        <DataAnnotationsValidator />

                        <MudTextField @bind-Value="model.Email"
                                      Label="Correo Electrónico"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Email"
                                      Required="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Email"
                                      FullWidth="true"
                                      Class="mb-3" />

                        <MudTextField @bind-Value="model.Token"
                                      Label="Código de Recuperación"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Key"
                                      FullWidth="true"
                                      Class="mb-3"
                                      HelperText="Ingresa el código que recibiste" />

                        <MudTextField @bind-Value="model.Password"
                                      Label="Nueva Contraseña"
                                      Variant="Variant.Outlined"
                                      InputType="@passwordInputType"
                                      Required="true"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@passwordIcon"
                                      OnAdornmentClick="TogglePasswordVisibility"
                                      FullWidth="true"
                                      Class="mb-3" />

                        <MudTextField @bind-Value="model.PasswordConfirm"
                                      Label="Confirmar Contraseña"
                                      Variant="Variant.Outlined"
                                      InputType="@passwordConfirmInputType"
                                      Required="true"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@passwordConfirmIcon"
                                      OnAdornmentClick="TogglePasswordConfirmVisibility"
                                      FullWidth="true"
                                      Class="mb-4" />

                        <ValidationSummary />

                        <MudButton ButtonType="MudBlazor.ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   Size="Size.Large"
                                   Disabled="loading"
                                   StartIcon="@Icons.Material.Filled.Check">
                            @if (loading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Surface" />
                                <span class="ms-2">Restableciendo...</span>
                            }
                            else
                            {
                                <span>Restablecer Contraseña</span>
                            }
                        </MudButton>
                    </EditForm>

                    <div class="text-center mt-4">
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Secondary"
                                   OnClick="GoToLogin"
                                   StartIcon="@Icons.Material.Filled.ArrowBack">
                            Volver al inicio de sesión
                        </MudButton>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string Email { get; set; } = string.Empty;

    private ResetPasswordDTO model = new();
    private bool loading = false;

    private bool showPassword = false;
    private bool showPasswordConfirm = false;

    private InputType passwordInputType => showPassword ? InputType.Text : InputType.Password;
    private InputType passwordConfirmInputType => showPasswordConfirm ? InputType.Text : InputType.Password;

    private string passwordIcon => showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    private string passwordConfirmIcon => showPasswordConfirm ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(Email))
        {
            model.Email = Email;
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void TogglePasswordConfirmVisibility()
    {
        showPasswordConfirm = !showPasswordConfirm;
    }

    private async Task ResetPasswordAsync()
    {
        if (model.Password != model.PasswordConfirm)
        {
            await sweetAlertService.FireAsync("Error", "Las contraseñas no coinciden", SweetAlertIcon.Error);
            return;
        }

        loading = true;

        var responseHttp = await repository.post("/api/accounts/ResetPassword", model);

        if (responseHttp.Error)
        {
            var message = await responseHttp.GetErrorMessageAsync();
            await sweetAlertService.FireAsync("Error", message, SweetAlertIcon.Error);
            loading = false;
            return;
        }

        loading = false;

        await sweetAlertService.FireAsync(new SweetAlertOptions
        {
            Title = "Éxito",
            Text = "Tu contraseña ha sido restablecida correctamente. Ahora puedes iniciar sesión con tu nueva contraseña.",
            Icon = SweetAlertIcon.Success,
            ShowCancelButton = false,
            ConfirmButtonText = "Ir al inicio de sesión"
        });

        navigationManager.NavigateTo("/login");
    }

    private void GoToLogin()
    {
        navigationManager.NavigateTo("/login");
    }
}
