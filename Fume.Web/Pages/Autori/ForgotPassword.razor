@page "/forgotpassword"
@inject IRepository repository
@inject SweetAlertService sweetAlertService
@inject NavigationManager navigationManager

<div class="container mt-5" style=" min-height: 90vh;">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-lg">
                <div class="card-header text-white text-center py-4" style="background: linear-gradient(135deg, #2196f3 0%, #4facf6 100%);">
                    <h3 class="mb-0">
                        <MudIcon Icon="@Icons.Material.Filled.LockReset" Size="Size.Large" />
                        <br />
                        ¿Olvidaste tu contraseña?
                    </h3>
                </div>
                <div class="card-body p-4">
                    @if (!tokenGenerated)
                    {
                        <p class="text-muted text-center mb-4">
                            Ingresa tu correo electrónico y te enviaremos un código para restablecer tu contraseña.
                        </p>

                        <EditForm Model="email" OnValidSubmit="SendResetTokenAsync">
                            <DataAnnotationsValidator />

                            <MudTextField @bind-Value="email"
                                          Label="Correo Electrónico"
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Email"
                                          Required="true"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Email"
                                          FullWidth="true"
                                          Class="mb-4" />

                            <MudButton ButtonType="MudBlazor.ButtonType.Submit"
                                       Variant="Variant.Filled"
                                       Color="Color.Info"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       Disabled="loading"
                                       StartIcon="@Icons.Material.Filled.Send">
                                @if (loading)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Surface" />
                                    <span class="ms-2">Enviando...</span>
                                }
                                else
                                {
                                    <span>Enviar Código</span>
                                }
                            </MudButton>
                        </EditForm>
                    }
                    else
                    {
                        <div class="text-center">
                            <MudIcon Icon="@Icons.Material.Filled.MarkEmailRead"
                                     Color="Color.Success"
                                     Style="font-size: 4rem;" />
                            <h5 class="mt-3 mb-3">Código Generado</h5>
                            <p class="text-muted mb-3">
                                Hemos generado un código para restablecer tu contraseña.
                            </p>

                            @if (!string.IsNullOrEmpty(resetToken))
                            {
                                <div class="alert alert-info">
                                    <strong>Token de recuperación:</strong>
                                    <div class="mt-2 p-2 bg-light border rounded">
                                        <code style="font-size: 0.9rem;">@resetToken</code>
                                    </div>
                                    <small class="d-block mt-2">
                                        Guarda este código para usarlo en la siguiente página.
                                    </small>
                                </div>
                            }

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       FullWidth="true"
                                       Size="Size.Large"
                                       OnClick="GoToResetPassword"
                                       StartIcon="@Icons.Material.Filled.ArrowForward"
                                       Class="mt-3">
                                Restablecer Contraseña
                            </MudButton>
                        </div>
                    }

                    <div class="text-center mt-4">
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Secondary"
                                   OnClick="GoToLogin"
                                   StartIcon="@Icons.Material.Filled.ArrowBack">
                            Volver al inicio de sesión
                        </MudButton>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string email = string.Empty;
    private bool loading = false;
    private bool tokenGenerated = false;
    private string resetToken = string.Empty;

    private async Task SendResetTokenAsync()
    {
        if (string.IsNullOrWhiteSpace(email))
        {
            await sweetAlertService.FireAsync("Error", "Por favor ingresa tu correo electrónico", SweetAlertIcon.Error);
            return;
        }

        loading = true;

        var model = new ForgotPasswordDTO { Email = email };
        var responseHttp = await repository.post<ForgotPasswordDTO, TokenResponse>("/api/accounts/ForgotPassword", model);

        if (responseHttp.Error)
        {
            var message = await responseHttp.GetErrorMessageAsync();
            await sweetAlertService.FireAsync("Error", message, SweetAlertIcon.Error);
            loading = false;
            return;
        }

        // El backend retorna el token (en producción esto sería un email)
        if (responseHttp.Response != null)
        {
            resetToken = responseHttp.Response.Token;
            tokenGenerated = true;
        }

        loading = false;
    }

    private void GoToResetPassword()
    {
        navigationManager.NavigateTo($"/resetpassword?email={email}");
    }

    private void GoToLogin()
    {
        navigationManager.NavigateTo("/login");
    }

    private class TokenResponse
    {
        public string Token { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
    }
}
