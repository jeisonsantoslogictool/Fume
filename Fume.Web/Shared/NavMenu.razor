@inject IRepository repository
@inject NavigationManager navigationManager
@inject Fume.Web.Services.CatalogNavigationService catalogNavigation

<MudNavMenu>

    <MudNavLink Href="/" Icon="@Icons.Material.Filled.ShoppingCart" IconColor="Color.Info" Style="cursor: pointer;">
        Fume
    </MudNavLink>
 

    <MudDivider Class="my-2" />

    @if (categories != null && categories.Any())
    {
        @foreach (var category in categories)
        {
            <MudNavGroup Title="@category.Name" Icon="@Icons.Material.Filled.Category" IconColor="Color.Primary">
                @if (category.SubCategories != null && category.SubCategories.Any())
                {
                    @foreach (var subCategory in category.SubCategories)
                    {
                        <MudNavLink Href="@($"/subcategory/{subCategory.Id}")"
                                    @onmouseenter="@(() => PrefetchSubCategory(subCategory))"
                                    Icon="@Icons.Material.Filled.Label"
                                    IconColor="Color.Secondary">
                            @subCategory.Name
                        </MudNavLink>
                    }
                }
                else
                {
                    <MudNavLink Href="@($"/category/{category.Id}")"
                                Icon="@Icons.Material.Filled.Inbox"
                                IconColor="Color.Default">
                        Ver categoría
                    </MudNavLink>
                }
            </MudNavGroup>
        }
    }

    <AuthorizeView Roles="Admin">
        <Authorized>
            <MudDivider Class="my-2" />
            <MudNavGroup Title="Administración" Icon="@Icons.Material.Filled.AdminPanelSettings" Expanded="false">
                <MudNavLink Href="/categories" Icon="@Icons.Material.Filled.Category" IconColor="Color.Warning">
                    Categorías
                </MudNavLink>
                <MudNavLink Href="/countries" Icon="@Icons.Material.Filled.Public" IconColor="Color.Secondary">
                    Países
                </MudNavLink>
                <MudNavLink Href="/products" Icon="@Icons.Material.Filled.Inventory" IconColor="Color.Info">
                    Productos
                </MudNavLink>
            </MudNavGroup>
        </Authorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    private List<Category>? categories;
    private HashSet<int> prefetchedSubCategories = new HashSet<int>();

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
    }

    private void PrefetchSubCategory(SubCategory subCategory)
    {
        // Marcar como pre-cargada para evitar múltiples llamadas
        if (!prefetchedSubCategories.Contains(subCategory.Id))
        {
            prefetchedSubCategories.Add(subCategory.Id);
            // Disparar el evento de pre-carga sin bloquear
            catalogNavigation.PrefetchSubCategory(subCategory);
        }
    }

    private async Task LoadCategoriesAsync()
    {
        try
        {
            var response = await repository.Get<List<Category>>("/api/categories/full?RecordsNumber=100");
            if (!response.Error)
            {
                categories = response.Response;
            }
        }
        catch
        {
            categories = new List<Category>();
        }
    }
}
