@inject IRepository repository
@inject NavigationManager navigationManager
@inject Fume.Web.Services.CatalogNavigationService catalogNavigation

<MudNavMenu>

    <MudNavLink Href="/" Icon="@Icons.Material.Filled.ShoppingCart" IconColor="Color.Info" OnClick="NavigateToHome">
        Fume
    </MudNavLink>
 

    <MudDivider Class="my-2" />

    <!-- Categorías y Subcategorías para todos los usuarios -->
    @if (categories != null && categories.Any())
    {
        @foreach (var category in categories)
        {
            <MudNavGroup Title="@category.Name" Icon="@Icons.Material.Filled.Category" IconColor="Color.Primary">
                @if (category.SubCategories != null && category.SubCategories.Any())
                {
                    @foreach (var subCategory in category.SubCategories)
                    {
                        <MudNavLink OnClick="@(() => NavigateToSubCategory(subCategory))"
                                    Icon="@Icons.Material.Filled.Label"
                                    IconColor="Color.Secondary">
                            @subCategory.Name
                        </MudNavLink>
                    }
                }
                else
                {
                    <MudNavLink OnClick="@(() => NavigateToCategory(category))"
                                Icon="@Icons.Material.Filled.Inbox"
                                IconColor="Color.Default">
                        Ver categoría
                    </MudNavLink>
                }
            </MudNavGroup>
        }
    }

    <AuthorizeView Roles="Admin">
        <Authorized>
            <MudDivider Class="my-2" />
            <MudNavGroup Title="Administración" Icon="@Icons.Material.Filled.AdminPanelSettings" Expanded="false">
                <MudNavLink Href="/categories" Icon="@Icons.Material.Filled.Category" IconColor="Color.Warning">
                    Categorías
                </MudNavLink>
                <MudNavLink Href="/countries" Icon="@Icons.Material.Filled.Public" IconColor="Color.Secondary">
                    Países
                </MudNavLink>
                <MudNavLink Href="/products" Icon="@Icons.Material.Filled.Inventory" IconColor="Color.Info">
                    Productos
                </MudNavLink>
            </MudNavGroup>
        </Authorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    private List<Category>? categories;
    private bool isNavigating = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
    }

    private async Task LoadCategoriesAsync()
    {
        try
        {
            var response = await repository.Get<List<Category>>("/api/categories/full?RecordsNumber=100");
            if (!response.Error)
            {
                categories = response.Response;
            }
        }
        catch
        {
            categories = new List<Category>();
        }
    }

    private async void NavigateToHome()
    {
        if (isNavigating) return;

        isNavigating = true;
        try
        {
            var uri = new Uri(navigationManager.Uri);
            if (uri.AbsolutePath != "/")
            {
                navigationManager.NavigateTo("/");
                await Task.Delay(100);
            }
            catalogNavigation.NavigateToCategories();
        }
        finally
        {
            await Task.Delay(300);
            isNavigating = false;
        }
    }

    private async void NavigateToCategory(Category category)
    {
        if (isNavigating) return;

        isNavigating = true;
        try
        {
            var uri = new Uri(navigationManager.Uri);
            if (uri.AbsolutePath != "/")
            {
                navigationManager.NavigateTo("/");
                await Task.Delay(100);
            }
            catalogNavigation.NavigateToCategory(category);
        }
        finally
        {
            await Task.Delay(300);
            isNavigating = false;
        }
    }

    private async void NavigateToSubCategory(SubCategory subCategory)
    {
        if (isNavigating) return;

        isNavigating = true;
        try
        {
            var uri = new Uri(navigationManager.Uri);
            if (uri.AbsolutePath != "/")
            {
                navigationManager.NavigateTo("/");
                await Task.Delay(100);
            }
            catalogNavigation.NavigateToSubCategory(subCategory);
        }
        finally
        {
            await Task.Delay(300);
            isNavigating = false;
        }
    }
}
